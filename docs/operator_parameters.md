Postgres Operator Configuration
===============================

Postgres operator is configured via a ConfigMap defined by the
*CONFIG_MAP_NAME* environment variable. Variable names are delimiter-separated
words.

Available Configuration Parameters
----------------------------------

* **etcd_host**
  Etcd host:port for Patroni. Not required when Patroni native Kubernetes
  support is used.

* **docker_image**
  Spilo docker image for Postgres instances. For production, don't rely on a
  default value, as it might be too old. Instead, build your own Spilo image
  from the [github repository](github.com/zalando/spilo).

* **workers**
  number of working routines the operator spawns to process requests to
  create/update/delete/sync clusters concurrently. Default is *4*.

* **pod_terminate_grace_period**
  Patroni pods will be [terminated
  forcefully](https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods)
  after this timeout. Default is '*5m*'

* **max_instances**
  operator will cap the number of instances in any given Postgres cluster
  managed by it to the value of this parameter. When -1 is specified, no limits
  are applied. Default is -1.

* **min_instances**
  operator will run at least the number of instances for any given Postgres
  cluster equal to the value of this parameter. When -1 is specified, no limits
  are applied. Default is -1.

* **resync_period**
  period between consecutive sync requests. Default is '*5m*'. 

### Postgres users
* **super_username**
  postgres superuser name created by *initdb*. Default is '*postgres*'.

* **replication_username**
  postgres user name used for replication between instances. Default is
  '*standby*'

### Kubernetes resources
* **pod_service_account_name**
  service account used by Patroni running on individual Pods to communicate
  with the operator. Required even if native Kubernetes support in Patroni is
  not used, because Patroni will still try to keep pod labels in sync with the
  instance role. A default value is *operator*.

* **pod_service_account_definition**
  operator will try to create the pod Service Account in the namespace that
  lacks it using the YAML definition provided by this option. If not defined, a
  simple definition which contains only the name will be used.

* **watched_namespace**
  operator watches for Postgres objects in the given namespace. If not
  specified, the value is taken from the operator namespace. A special '*'
  value makes it watch all namespaces.

* **pdb_name_format**
 defines the template for PDB (Pod Disruption Budget) names created by the
 operator. Default is '*postgres-{cluster}-pdb*', where '*{cluster}*' is the
 cluster name.

* **secret_name_template**
  a template for the name of the database user secrets generated by the
  operator. '{*username*}' is the name of the secret, '{*cluster*'} is the name
  of the cluster, '{*tprkind*}' is the kind of CRD (formerly known as TPR) and
  '{*tprgroup*}' is the group of the CRD. Default is
  '*{username}.{cluster}.credentials.{tprkind}.{tprgroup}*'

* **oauth_token_secret_name**
  a name of the secret containing the OAuth2 token to pass to the teams API.
  Default is '*postgresql-operator*'

* **infrastructure_roles_secret_name**
  name of the secret containing infrastructure roles names and passwords.

* **pod_role_label**
  name of the label assigned to the Postgres pods (and services/endpoints) by
  the operator. Default is '*spilo-role*'.

* **cluster_labels**
  list of name:value pairs for additional labels assigned to the cluster objects. Default is '*application:spilo*'.

* **cluster_name_label**
  name of the label assigned to Kubernetes objects created by the operator that
  indicates which cluster a given object belongs to. Default is
  '*cluster-name'*.

* **node_readiness_label**
  a set of labels that a running and active node should possess to be
  considered *ready.* The operator uses values for those labels to detect the
  start of the Kubernetes cluster upgrade procedure and move master pods off
  the nodes to be decommissioned. When the set is not empty, the operator also
  assigns an Affinity clause to the Postgres pods to be scheduled only on
  *ready* nodes. Default is "" (empty).

* **toleration**
  a dictionary that should contain '*key*', '*operator*', '*value*' and
  '*effect*' keys. In that case, the operator will define a pod toleration
  according to the values of those keys. See [kubernetes
  documentation](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/)
  for details on taints and tolerations. Default is an empty value.

### Kubernetes resource requests
* **default_cpu_request**
  CPU request value for the Postgres containers, unless overridden by
  cluster-specific settings. Default is '*100m*'.

* **default_memory_request**
  memory request value for the Postgres containers, unless overridden by
  cluster-specific settings. Default is '*100Mi*'.

* **default_cpu_limit**
  CPU limits for the Postgres containers, unless overridden by cluster-specific
  settings. Default is '*3*'.

* **default_memory_limit**
  memory limits for the Postgres containers, unless overridden by cluster-specific
  settings. Default is '*1Gi*'.

### Operator timeouts
* **resource_check_interval**
  interval to wait between consecutive attempts to check for the presence of
  some Kubernetes resource (i.e. StatefulSet or PodDisruptionBudget). Default
  is '*3s*'.

* **resource_check_timeout**
  timeout when waiting for the presence of a certain Kubernetes resource (i.e.
  StatefulSet or PodDisruptionBudget) before declaring the operation
  unsuccessful. Default is "*10m*".

* **pod_label_wait_timeout**
  timeout when waiting for the pod role and cluster labels. Bigger value gives
  Patroni more time to start the instance, smaller makes the operator detect
  possible issues faster. Default is '*10m*'.

* **pod_deletion_wait_timeout**
  timeout when waiting for the pods to be deleted when removing the cluster or
  recreating pods. Default is '*10m*'.

* **ready_wait_interval**
  the interval between consecutive attempts waiting for the Postgres CRD to be
  created. Default is '*5s*'.

* **ready_wait_timeout**
  the timeout for the complete Postgres CRD creation. Default is '*30s*'.

### Load balancer related options
* **db_hosted_zone**
  DNS zone for the cluster DNS name when the load balancer is configured for
  the cluster. Default is *db.example.com*. Only used when combined with
  [external-dns](https://github.com/kubernetes-incubator/external-dns) and the
  cluster has the load balancer enabled.

* **enable_master_load_balancer**
  toggles service type load balancer pointing to the master pod of the cluster.
  Enabled by default and can be overridden by individual cluster settings.

* **enable_replica_load_balancer**
  toggles service type load balancer pointing to the replica pod of the cluster.
  Disabled by default and can be overridden by individual cluster settings.

* **master_dns_name_format**
  defines the DNS name string template for the master load balancer cluster.
  Default is '*{cluster}.{team}.{hostedzone}*', where '*{cluster}*' is the cluster
  name, '*{team}*' denotes the team name and '*{hostedzone}*' is the
  **db_hosted_zone** value.

* **replica_dns_name_format**
  defines the DNS name string template for the replica load balancer. Default
  is '*{cluster}-repl.{team}.{hostedzone}*', where '*{cluster}*' is the cluster
  name, '*{team}*' denotes the team name and '*{hostedzone}*' is the
  **db_hosted_zone** value.
 
### AWS or GSC interaction
* **wal_s3_bucket**
  S3 bucket to use for shipping WAL segments with WAL-E. A bucket has to be
  present and accessible by Patroni managed pods. At the moment, supported
  services by Spilo are S3 and GCS.

* **log_s3_bucket**
  S3 bucket to use for shipping Postgres daily logs. Works only with S3 on AWS.
  The bucket has to be present and accessible by Patroni managed pods. At the
  moment Spilo does not yet support this.

* **kube_iam_role**
  AWS IAM role to supply in the *iam.amazonaws.com/role* annotation of Patroni
  pods. Only used when combined with
  [kube2iam](https://github.com/jtblin/kube2iam) project on AWS

### Debugging the operator
* **debug_logging**
  boolean parameter that switches verbose debug logs from the operator. Enabled
  by default.

* **enable_db_access**
  boolean parameter that toggles the functionality of the operator that require
  access to the Postgres database, i.e. creating databases and users. Enabled
  by default.

### Automatic creation of database human users
* **enable_teams_api**
  boolean parameter that toggles usage of the Teams API by the operator.
  Enabled by default.

* **teams_api_url**
  contains the URL of the Teams API service. There is a [demo
  implementation](https://github.com/ikitiki/fake-teams-api). Default is
  https://teams.example.com/api/. 

* **team_api_role_configuration**
  Postgres parameters to apply to each team member role. Default is
  '*log_statement:all*'. It is possible to supply multiple options, separating
  them by commas. Options containing commas within the value are not supported,
  with an exception of the '*search_path*'. For instance 

  ```yaml
  teams_api_role_configuration: "log_statement:all,search_path:'data,public'"
  ```

* **enable_team_superuser**
  whether to grant superuser to team members created from the Teams API.
  Disabled by default.

* **team_admin_role**
  role name to grant to team members created from the Teams API. Default is
  '*admin*', which is the role created by Spilo.

* **pam_role_name**
  when set, the operator will add all team member roles to this group and add
  a *pg_hba* line to authenticate members of that role via pam. Default is '*zalandos*'.

* **pam_configuration**
  when set, should contain a URL to use for authentication against the user
  name and the token supplied as the password.  Used in conjunction with
  [pam_oauth2](https://github.com/CyberDem0n/pam-oauth2) module. Default is
  "*https://info.example.com/oauth2/tokeninfo?access_token= uid
  realm=/employees*"

* **protected_roles**
  List of roles that cannot be overwritten by an application, team or
  infrastructure role. Default is '*admin*'.

### Logging and REST API
* **api_port**
  REST API listener listens to this port. Default is *8080*.

* **ring_log_lines**
  number of lines in the ring buffer used to store cluster logs. Default is *100*.

* **cluster_history_entries**
  number of entries in the cluster history ring buffer. Default is *1000*

## Scalyr options
* **scalyr_api_key**
  API key for the Scalyr sidecar. Default is empty.

* **scalyr_image**
  Docker image for the Scalyr sidecar. Default is empty.

* **scalyr_server_url**
  server URL for the Scalyr sidecar. Default is "*https://upload.eu.scalyr.com*".

* **scalyr_cpu_request**
  CPU request value for the Scalyr sidecar. Default is '*100m*'.

* **scalyr_memory_request**
  Memory request value for the Scalyr sidecar.Default is '50Mi'.

* **scalyr_cpu_limit**
  CPU limit value for the Scalyr sidecar. Default is '*1*'.

* **scalyr_memory_limit**
  Memory limit value for the Scalyr sidecar.Default is '1Gi'.



